<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Baklava - Media Request Manager</title>
</head>
<body>
    <div id="BaklavaConfigPage" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary">
                <div style="text-align: center; margin-bottom: 20px;">
                    <!-- Plugin logo loaded from GitHub (plugins can't serve static files via HTTP GET) -->
                    <img src="https://raw.githubusercontent.com/j4ckgrey/Baklava/main/Baklava.png" alt="Baklava Logo" style="max-width: 200px; height: auto; border-radius: 8px;" onerror="this.style.display='none';">
                </div>
                <h2 style="text-align: center;">Baklava - Media Request Manager</h2>
                <h3 style="text-align: center;">Plugin Settings</h3>
                
                <!-- TMDB API Key -->
                <div style="margin-bottom: 20px;">
                    <label for="tmdbApiKey" style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">TMDB API Key (required for title search)</label>
                    <input id="tmdbApiKey" type="text" placeholder="Enter TMDB API Key" style="width:420px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                </div>

                <!-- Discord Webhook URL -->
                <div style="margin-bottom: 20px;">
                    <label for="discordWebhookUrl" style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Discord Webhook URL (for media request notifications)</label>
                    <input id="discordWebhookUrl" type="text" placeholder="https://discord.com/api/webhooks/..." style="width:420px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">
                        Get notified in Discord when users request media. Leave empty to disable notifications.
                    </p>
                </div>

                <!-- Search Filter Settings -->
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h4 style="margin-top: 0; color: #1e90ff;">Search Settings</h4>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="forceTVClientLocalSearch" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Force Local Search for TV Clients</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            When enabled, all TV clients will only see local library results. This is useful for restricting external search on shared/public servers.
                        </p>
                    </div>
                </div>

                <!-- Request Settings -->
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h4 style="margin-top: 0; color: #1e90ff;">Request Settings</h4>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="disableNonAdminRequests" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Enable Auto Import</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            When enabled, non-admin users will be able to "Importer" directly instead of "Request" for items in the library.
                        </p>
                    </div>
                </div>

                <!-- UI Settings -->
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h4 style="margin-top: 0; color: #1e90ff;">UI Settings</h4>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input id="showReviewsCarousel" type="checkbox" style="margin-right: 8px;">
                            <span style="color:#ddd;">Enable Reviews in details pages</span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            When enabled, a carousel of user reviews will be displayed above the Cast & Crew section on movie and TV show details pages.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: not-allowed; opacity: 0.5;">
                            <input id="enableDownloads" type="checkbox" style="margin-right: 8px;" disabled>
                            <span style="color:#ddd;">Enable Downloads <span style="color:#ff6b6b;">[EXPERIMENTAL, DISABLED DUE TO INSTABILITY, RELEASE DATE IS CURRENTLY UNKNOWN]</span></span>
                        </label>
                        <p style="margin: 4px 0 0 28px; font-size: 12px; color: #999;">
                            Allows users to queue media for offline playback within the app. Downloads are cached per-user and can be streamed directly without leaving Jellyfin.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label for="versionUiSelect" style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Version UI</label>
                        <select id="versionUiSelect" style="width:260px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                            <option value="carousel">Carousel</option>
                            <option value="dropdown">Dropdown</option>
                        </select>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">
                            Choose UI for version selection.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label for="audioUiSelect" style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Audio UI</label>
                        <select id="audioUiSelect" style="width:260px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                            <option value="carousel">Carousel</option>
                            <option value="dropdown">Dropdown</option>
                        </select>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">
                            Choose UI for audio track selection.
                        </p>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label for="subtitleUiSelect" style="display:block;margin-bottom:6px;color:#ddd;font-weight:600;">Subtitle UI</label>
                        <select id="subtitleUiSelect" style="width:260px;padding:6px;border-radius:4px;border:1px solid #444;background:#111;color:#fff;">
                            <option value="carousel">Carousel</option>
                            <option value="dropdown">Dropdown</option>
                        </select>
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">
                            Choose UI for subtitle selection.
                        </p>
                    </div>
                </div>

                <div>
                    <button id="saveConfigBtn" style="padding:8px 16px;border-radius:4px;border:none;background:#1e90ff;color:#fff;cursor:pointer;font-size:14px;">Save Configuration</button>
                    <div id="configStatus" style="margin-top:8px;color:#ccc;font-size:13px;"></div>
                </div>

                <script>
                    async function loadConfig(){
                        try{
                            if (window.ApiClient && window.ApiClient.ajax) {
                                let response = await window.ApiClient.ajax({ type: 'GET', url: window.ApiClient.getUrl('api/baklava/config'), dataType: 'json' });
                                if (response && response.constructor && response.constructor.name === 'Response') response = await response.json();
                                document.getElementById('tmdbApiKey').value = response?.tmdbApiKey || '';
                                document.getElementById('discordWebhookUrl').value = response?.discordWebhookUrl || '';
                                document.getElementById('forceTVClientLocalSearch').checked = response?.forceTVClientLocalSearch === true;
                                document.getElementById('disableNonAdminRequests').checked = response?.disableNonAdminRequests === true;
                                document.getElementById('showReviewsCarousel').checked = response?.showReviewsCarousel !== false;
                                document.getElementById('enableDownloads').checked = response?.enableDownloads === true;
                                document.getElementById('versionUiSelect').value = response?.versionUi || 'carousel';
                                document.getElementById('audioUiSelect').value = response?.audioUi || 'carousel';
                                document.getElementById('subtitleUiSelect').value = response?.subtitleUi || 'carousel';
                                console.log('[Baklava][Config] Loaded config:', response);
                                return;
                            }

                            const url = (window.ApiClient && window.ApiClient.getUrl) ? window.ApiClient.getUrl('api/baklava/config') : (window.location.origin + '/api/baklava/config');
                            const res = await fetch(url, { credentials: 'same-origin' });
                            if (!res.ok) throw new Error('Failed to load config');
                            const json = await res.json();
                            document.getElementById('tmdbApiKey').value = json.tmdbApiKey || '';
                            document.getElementById('discordWebhookUrl').value = json.discordWebhookUrl || '';
                            document.getElementById('forceTVClientLocalSearch').checked = json.forceTVClientLocalSearch === true;
                            document.getElementById('disableNonAdminRequests').checked = json.disableNonAdminRequests === true;
                            document.getElementById('showReviewsCarousel').checked = json.showReviewsCarousel !== false;
                            document.getElementById('enableDownloads').checked = json.enableDownloads === true;
                            document.getElementById('versionUiSelect').value = json.versionUi || 'carousel';
                            document.getElementById('audioUiSelect').value = json.audioUi || 'carousel';
                            document.getElementById('subtitleUiSelect').value = json.subtitleUi || 'carousel';
                            console.log('[Baklava][Config] Loaded config:', json);
                        }catch(e){ 
                            console.error('[Baklava][Config] Load error:', e); 
                        }
                    }

                    document.getElementById('saveConfigBtn').addEventListener('click', async ()=>{
                        const key = document.getElementById('tmdbApiKey').value;
                        const discordWebhookUrl = document.getElementById('discordWebhookUrl').value;
                        const forceTVLocal = document.getElementById('forceTVClientLocalSearch').checked;
                        const disableNonAdminRequests = document.getElementById('disableNonAdminRequests').checked;
                        const showReviewsCarousel = document.getElementById('showReviewsCarousel').checked;
                        const versionUi = document.getElementById('versionUiSelect').value || 'carousel';
                        const audioUi = document.getElementById('audioUiSelect').value || 'carousel';
                        const subtitleUi = document.getElementById('subtitleUiSelect').value || 'carousel';

                        const configData = {
                            tmdbApiKey: key,
                            discordWebhookUrl: discordWebhookUrl,
                            enableSearchFilter: false,
                            forceTVClientLocalSearch: forceTVLocal,
                            disableNonAdminRequests: disableNonAdminRequests,
                            showReviewsCarousel: showReviewsCarousel,
                            enableDownloads: document.getElementById('enableDownloads').checked,
                            versionUi: versionUi,
                            audioUi: audioUi,
                            subtitleUi: subtitleUi
                        };
                        
                        try {
                            // Prefer ApiClient.ajax which includes authentication and proper headers
                            if (window.ApiClient && window.ApiClient.ajax) {
                                const ajaxOpts = {
                                    type: 'PUT',
                                    url: window.ApiClient.getUrl('api/baklava/config'),
                                    data: JSON.stringify(configData),
                                    contentType: 'application/json'
                                };
                                const res = await window.ApiClient.ajax(ajaxOpts);
                                console.log('[Baklava][Config] ApiClient.ajax PUT result:', res);
                                // Some ApiClient implementations return Response-like objects
                                if (res && ((res.status && res.status === 403) || (res.statusCode && res.statusCode === 403))) {
                                    document.getElementById('configStatus').textContent = 'Forbidden: admin only';
                                    return;
                                }
                                // If res is a Response-like object, check ok
                                if (res && res.constructor && res.constructor.name === 'Response') {
                                    if (!res.ok) {
                                        document.getElementById('configStatus').textContent = 'Error saving configuration';
                                        console.error('[Baklava][Config] PUT failed (Response):', res);
                                        return;
                                    }
                                }
                                // Update cached plugin config in page context so client code picks it up immediately
                                try { if (window.MediaServerUI) window.MediaServerUI._pluginConfig = configData; } catch(e) {}
                                document.getElementById('configStatus').textContent = 'Configuration saved successfully!';
                                return;
                            }

                            const url = (window.ApiClient && window.ApiClient.getUrl) ? window.ApiClient.getUrl('api/baklava/config') : (window.location.origin + '/api/baklava/config');
                            const res = await fetch(url, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(configData),
                                credentials: 'same-origin'
                            });
                            console.log('[Baklava][Config] fetch PUT result:', res);
                            if (res.status === 403) {
                                document.getElementById('configStatus').textContent = 'Forbidden: admin only';
                                return;
                            }
                            if (!res.ok) throw new Error('Save failed');
                            try { if (window.MediaServerUI) window.MediaServerUI._pluginConfig = configData; } catch(e) {}
                            document.getElementById('configStatus').textContent = 'Configuration saved successfully!';
                        } catch (err) {
                            document.getElementById('configStatus').textContent = 'Error saving configuration';
                            console.error('[Baklava][Config] Save error:', err);
                        }
                    });

                    loadConfig().catch(err => {
                        console.error('[Baklava][Config] Failed to load config:', err);
                    });
                </script>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        console.log('[Baklava] Configuration page loaded');
    </script>
</body>
</html>
