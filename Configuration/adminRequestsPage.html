<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Baklava - Manage Media Requests</title>
</head>
<body>
    <div id="BaklavaAdminRequestsPage" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="https://raw.githubusercontent.com/j4ckgrey/Baklava/main/Baklava.png" alt="Baklava Logo" style="max-width: 200px; height: auto; border-radius: 8px;" onerror="this.style.display='none';">
                </div>
                <h2 style="text-align: center;">Manage Media Requests</h2>

                <div id="adminRequestsContainer">
                    <!-- Movies Section -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #1e90ff; border-bottom: 2px solid #1e90ff; padding-bottom: 8px;">Movie Requests</h3>
                        <div id="adminMoviesContainer" style="display: flex; flex-wrap: wrap; gap: 15px; min-height: 100px; padding: 15px 0;">
                            <div style="color: #999; padding: 20px;">Loading...</div>
                        </div>
                    </div>

                    <!-- Series Section -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #1e90ff; border-bottom: 2px solid #1e90ff; padding-bottom: 8px;">Series Requests</h3>
                        <div id="adminSeriesContainer" style="display: flex; flex-wrap: wrap; gap: 15px; min-height: 100px; padding: 15px 0;">
                            <div style="color: #999; padding: 20px;">Loading...</div>
                        </div>
                    </div>
                </div>

                <script>
                    // Load requests from API and display them
                    async function loadAdminRequests() {
                        try {
                            if (!window.ApiClient) {
                                console.warn('[AdminRequests] ApiClient not available yet');
                                setTimeout(loadAdminRequests, 500);
                                return;
                            }

                            const response = await window.ApiClient.ajax({
                                type: 'GET',
                                url: window.ApiClient.getUrl('api/baklava/requests'),
                                dataType: 'json'
                            });

                            const requests = Array.isArray(response) ? response : [];
                            console.log('[AdminRequests] Loaded', requests.length, 'requests');

                            // Get current user to check admin status
                            const userId = window.ApiClient.getCurrentUserId();
                            const user = await window.ApiClient.getUser(userId);
                            const isAdmin = user?.Policy?.IsAdministrator || false;

                            if (!isAdmin) {
                                document.getElementById('adminMoviesContainer').innerHTML = '<div style="color: #f44336; padding: 20px;">Access denied: Admin only</div>';
                                document.getElementById('adminSeriesContainer').innerHTML = '';
                                return;
                            }

                            // Split by item type - show ALL requests from all users
                            const movies = requests.filter(r => r.itemType === 'movie');
                            const series = requests.filter(r => r.itemType === 'series');

                            displayAdminCards('adminMoviesContainer', movies);
                            displayAdminCards('adminSeriesContainer', series);

                        } catch (err) {
                            console.error('[AdminRequests] Error loading requests:', err);
                            document.getElementById('adminMoviesContainer').innerHTML = '<div style="color: #f44336; padding: 20px;">Error loading requests</div>';
                            document.getElementById('adminSeriesContainer').innerHTML = '<div style="color: #f44336; padding: 20px;">Error loading requests</div>';
                        }
                    }

                    function displayAdminCards(containerId, requests) {
                        const container = document.getElementById(containerId);

                        if (requests.length === 0) {
                            container.innerHTML = '<div style="color: #666; padding: 20px; font-style: italic;">No requests</div>';
                            return;
                        }

                        container.innerHTML = '';

                        requests.forEach(request => {
                            const card = createAdminRequestCard(request);
                            container.appendChild(card);
                        });
                    }

                    function createAdminRequestCard(request) {
                        const card = document.createElement('div');
                        card.className = 'admin-request-card';
                        card.style.cssText = `
                            display: inline-block;
                            width: 140px;
                            position: relative;
                            flex-shrink: 0;
                            border-radius: 8px;
                            overflow: hidden;
                            background: rgba(30, 30, 30, 0.5);
                            transition: transform 0.2s ease, box-shadow 0.2s ease;
                        `;

                        // Image
                        const imgDiv = document.createElement('div');
                        imgDiv.style.cssText = `
                            width: 100%;
                            height: 210px;
                            background-size: cover;
                            background-position: center;
                            position: relative;
                            background-color: #1a1a1a;
                            background-image: ${request.img};
                        `;

                        // Gradient overlay
                        const overlay = document.createElement('div');
                        overlay.style.cssText = `
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            height: 60px;
                            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 100%);
                            pointer-events: none;
                        `;
                        imgDiv.appendChild(overlay);

                        // Status badge (top-right)
                        const statusBadge = document.createElement('div');
                        if (request.status === 'pending') {
                            statusBadge.textContent = 'Pending';
                            statusBadge.style.background = 'rgba(255, 152, 0, 0.95)';
                        } else if (request.status === 'approved') {
                            statusBadge.textContent = '✓ Approved';
                            statusBadge.style.background = 'rgba(76, 175, 80, 0.95)';
                        } else if (request.status === 'rejected') {
                            statusBadge.textContent = '✗ Rejected';
                            statusBadge.style.background = 'rgba(244, 67, 54, 0.95)';
                        }
                        statusBadge.style.cssText += `
                            position: absolute;
                            top: 6px;
                            right: 6px;
                            color: #fff;
                            padding: 4px 8px;
                            border-radius: 12px;
                            font-size: 10px;
                            font-weight: 700;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                            z-index: 2;
                        `;
                        imgDiv.appendChild(statusBadge);

                        // Username badge (bottom-left)
                        if (request.username) {
                            const userBadge = document.createElement('div');
                            userBadge.textContent = request.username;
                            userBadge.title = `Requested by ${request.username}`;
                            userBadge.style.cssText = `
                                position: absolute;
                                bottom: 0;
                                left: 6px;
                                background: rgba(30, 144, 255, 0.95);
                                color: #fff;
                                padding: 4px 8px;
                                border-radius: 12px;
                                font-size: 10px;
                                font-weight: 700;
                                max-width: 120px;
                                overflow: hidden;
                                text-overflow: ellipsis;
                                white-space: nowrap;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                z-index: 2;
                            `;
                            imgDiv.appendChild(userBadge);
                        }

                        card.appendChild(imgDiv);

                        // Title section
                        const titleDiv = document.createElement('div');
                        titleDiv.style.cssText = `
                            padding: 8px;
                            background: rgba(20, 20, 20, 0.9);
                            min-height: 40px;
                        `;

                        const titleText = document.createElement('div');
                        titleText.textContent = request.title || 'Unknown';
                        titleText.title = request.title || 'Unknown';
                        titleText.style.cssText = `
                            font-size: 12px;
                            font-weight: 600;
                            color: #fff;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            display: -webkit-box;
                            -webkit-line-clamp: 2;
                            -webkit-box-orient: vertical;
                            line-height: 1.3;
                            margin-bottom: 2px;
                        `;
                        titleDiv.appendChild(titleText);

                        if (request.year) {
                            const yearText = document.createElement('div');
                            yearText.textContent = request.year;
                            yearText.style.cssText = `
                                font-size: 10px;
                                color: #999;
                                font-weight: 500;
                            `;
                            titleDiv.appendChild(yearText);
                        }

                        card.appendChild(titleDiv);

                        // Action buttons section (for pending requests)
                        if (request.status === 'pending') {
                            const actionsDiv = document.createElement('div');
                            actionsDiv.style.cssText = `
                                padding: 8px;
                                background: rgba(15, 15, 15, 0.9);
                                display: flex;
                                gap: 8px;
                                justify-content: space-between;
                            `;

                            // Approve button
                            const approveBtn = document.createElement('button');
                            approveBtn.textContent = 'Approve';
                            approveBtn.style.cssText = `
                                flex: 1;
                                padding: 6px;
                                background: rgba(76, 175, 80, 0.8);
                                color: #fff;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                font-weight: 600;
                                transition: background 0.2s;
                            `;
                            approveBtn.addEventListener('mouseover', () => {
                                approveBtn.style.background = 'rgba(76, 175, 80, 1)';
                            });
                            approveBtn.addEventListener('mouseout', () => {
                                approveBtn.style.background = 'rgba(76, 175, 80, 0.8)';
                            });
                            approveBtn.addEventListener('click', async () => {
                                await updateRequestStatus(request.id, 'approved');
                            });

                            // Reject button
                            const rejectBtn = document.createElement('button');
                            rejectBtn.textContent = 'Reject';
                            rejectBtn.style.cssText = `
                                flex: 1;
                                padding: 6px;
                                background: rgba(244, 67, 54, 0.8);
                                color: #fff;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                font-weight: 600;
                                transition: background 0.2s;
                            `;
                            rejectBtn.addEventListener('mouseover', () => {
                                rejectBtn.style.background = 'rgba(244, 67, 54, 1)';
                            });
                            rejectBtn.addEventListener('mouseout', () => {
                                rejectBtn.style.background = 'rgba(244, 67, 54, 0.8)';
                            });
                            rejectBtn.addEventListener('click', async () => {
                                await updateRequestStatus(request.id, 'rejected');
                            });

                            actionsDiv.appendChild(approveBtn);
                            actionsDiv.appendChild(rejectBtn);
                            card.appendChild(actionsDiv);
                        }

                        // Delete button for approved/rejected requests
                        if (request.status === 'approved' || request.status === 'rejected') {
                            const deleteDiv = document.createElement('div');
                            deleteDiv.style.cssText = `
                                padding: 8px;
                                background: rgba(15, 15, 15, 0.9);
                            `;

                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.style.cssText = `
                                width: 100%;
                                padding: 6px;
                                background: rgba(150, 150, 150, 0.8);
                                color: #fff;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 11px;
                                font-weight: 600;
                                transition: background 0.2s;
                            `;
                            deleteBtn.addEventListener('mouseover', () => {
                                deleteBtn.style.background = 'rgba(200, 200, 200, 0.9)';
                            });
                            deleteBtn.addEventListener('mouseout', () => {
                                deleteBtn.style.background = 'rgba(150, 150, 150, 0.8)';
                            });
                            deleteBtn.addEventListener('click', async () => {
                                if (confirm(`Delete request for "${request.title}"?`)) {
                                    await deleteRequestById(request.id);
                                }
                            });

                            deleteDiv.appendChild(deleteBtn);
                            card.appendChild(deleteDiv);
                        }

                        // Hover effects
                        card.addEventListener('mouseenter', () => {
                            card.style.transform = 'translateY(-4px) scale(1.02)';
                            card.style.boxShadow = '0 8px 16px rgba(0,0,0,0.6)';
                        });
                        card.addEventListener('mouseleave', () => {
                            card.style.transform = 'translateY(0) scale(1)';
                            card.style.boxShadow = 'none';
                        });

                        return card;
                    }

                    async function updateRequestStatus(requestId, status) {
                        try {
                            const userId = window.ApiClient.getCurrentUserId();
                            const user = await window.ApiClient.getUser(userId);
                            const approvedBy = user?.Name || 'Admin';

                            const payload = { status, approvedBy };

                            await window.ApiClient.ajax({
                                type: 'PUT',
                                url: window.ApiClient.getUrl(`api/baklava/requests/${requestId}`),
                                data: JSON.stringify(payload),
                                contentType: 'application/json'
                            });

                            console.log('[AdminRequests] Request status updated to:', status);

                            // Reload the page
                            await loadAdminRequests();
                        } catch (err) {
                            console.error('[AdminRequests] Error updating status:', err);
                            alert('Error updating request status');
                        }
                    }

                    async function deleteRequestById(requestId) {
                        try {
                            await window.ApiClient.ajax({
                                type: 'DELETE',
                                url: window.ApiClient.getUrl(`api/baklava/requests/${requestId}`)
                            });

                            console.log('[AdminRequests] Request deleted');

                            // Reload the page
                            await loadAdminRequests();
                        } catch (err) {
                            console.error('[AdminRequests] Error deleting request:', err);
                            alert('Error deleting request');
                        }
                    }

                    // Initialize on page load
                    loadAdminRequests();

                    // Reload periodically
                    setInterval(loadAdminRequests, 30000);
                </script>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        console.log('[Baklava] Admin Requests page loaded');
    </script>
</body>
</html>
